<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Sensores - DTMF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .status {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            font-size: 1.2em;
        }
        
        .sensor-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .sensor-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .sensor-box h3 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
        }
        
        .value {
            font-size: 2em;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .axis {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 1.1em;
        }
        
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s;
        }
        
        .button:hover {
            background: #45a049;
        }
        
        .button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .button.danger {
            background: #f44336;
        }
        
        .button.danger:hover {
            background: #da190b;
        }
        
        .logs {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        
        .log-info { color: #4CAF50; }
        .log-warning { color: #FF9800; }
        .log-error { color: #f44336; }
        .log-success { color: #8BC34A; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Prueba de Sensores</h1>
        
        <div class="status" id="status">
            Iniciando prueba de sensores...
        </div>
        
        <div style="text-align: center;">
            <button class="button" id="permission-btn">Solicitar Permisos</button>
            <button class="button" id="start-btn" disabled>Iniciar Sensores</button>
            <button class="button danger" id="stop-btn" disabled>Detener Sensores</button>
        </div>
        
        <div class="sensor-data">
            <div class="sensor-box">
                <h3>📱 Acelerómetro</h3>
                <div class="axis">
                    <span>X:</span>
                    <span class="value" id="accel-x">0.00</span>
                </div>
                <div class="axis">
                    <span>Y:</span>
                    <span class="value" id="accel-y">0.00</span>
                </div>
                <div class="axis">
                    <span>Z:</span>
                    <span class="value" id="accel-z">0.00</span>
                </div>
                <div class="axis">
                    <span>Magnitud:</span>
                    <span class="value" id="accel-magnitude">0.00</span>
                </div>
            </div>
            
            <div class="sensor-box">
                <h3>🔄 Giroscopio</h3>
                <div class="axis">
                    <span>Alpha:</span>
                    <span class="value" id="gyro-alpha">0.00</span>
                </div>
                <div class="axis">
                    <span>Beta:</span>
                    <span class="value" id="gyro-beta">0.00</span>
                </div>
                <div class="axis">
                    <span>Gamma:</span>
                    <span class="value" id="gyro-gamma">0.00</span>
                </div>
                <div class="axis">
                    <span>Magnitud:</span>
                    <span class="value" id="gyro-magnitude">0.00</span>
                </div>
            </div>
        </div>
        
        <div class="logs" id="logs">
            <div class="log-entry log-info">Sistema iniciado. Esperando permisos...</div>
        </div>
    </div>

    <script>
        // Variables globales
        let isListening = false;
        let permissionGranted = false;
        let lastUpdate = 0;
        const updateInterval = 100; // Actualizar cada 100ms
        
        // Elementos del DOM
        const statusEl = document.getElementById('status');
        const permissionBtn = document.getElementById('permission-btn');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const logsEl = document.getElementById('logs');
        
        // Elementos de datos
        const accelX = document.getElementById('accel-x');
        const accelY = document.getElementById('accel-y');
        const accelZ = document.getElementById('accel-z');
        const accelMagnitude = document.getElementById('accel-magnitude');
        const gyroAlpha = document.getElementById('gyro-alpha');
        const gyroBeta = document.getElementById('gyro-beta');
        const gyroGamma = document.getElementById('gyro-gamma');
        const gyroMagnitude = document.getElementById('gyro-magnitude');
        
        // Función para agregar logs
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsEl.appendChild(logEntry);
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        // Función para actualizar el estado
        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status log-${type}`;
        }
        
        // Función para solicitar permisos
        async function requestPermissions() {
            addLog('Solicitando permisos de sensores...', 'info');
            
            if (typeof DeviceMotionEvent === 'undefined') {
                addLog('DeviceMotionEvent no está disponible', 'error');
                updateStatus('Sensores no disponibles', 'error');
                return false;
            }
            
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceMotionEvent.requestPermission();
                    addLog(`Permiso de sensores: ${permission}`, permission === 'granted' ? 'success' : 'warning');
                    
                    if (permission === 'granted') {
                        permissionGranted = true;
                        startBtn.disabled = false;
                        permissionBtn.textContent = 'Permisos OK';
                        permissionBtn.disabled = true;
                        updateStatus('Permisos concedidos. Listo para iniciar sensores.', 'success');
                        return true;
                    } else {
                        updateStatus('Permisos denegados', 'error');
                        return false;
                    }
                } catch (error) {
                    addLog(`Error solicitando permisos: ${error.message}`, 'error');
                    updateStatus('Error solicitando permisos', 'error');
                    return false;
                }
            } else {
                addLog('No es iOS - sensores disponibles directamente', 'info');
                permissionGranted = true;
                startBtn.disabled = false;
                permissionBtn.textContent = 'No necesario';
                permissionBtn.disabled = true;
                updateStatus('Sensores disponibles. Listo para iniciar.', 'success');
                return true;
            }
        }
        
        // Función para iniciar sensores
        function startSensors() {
            if (!permissionGranted) {
                addLog('Primero debe conceder permisos', 'warning');
                return;
            }
            
            addLog('Iniciando sensores...', 'info');
            isListening = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            updateStatus('Sensores activos. Mueve el dispositivo...', 'success');
            
            // Agregar listener de movimiento
            window.addEventListener('devicemotion', handleMotion);
            addLog('Listener de devicemotion agregado', 'success');
        }
        
        // Función para detener sensores
        function stopSensors() {
            addLog('Deteniendo sensores...', 'info');
            isListening = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            updateStatus('Sensores detenidos', 'warning');
            
            // Remover listener
            window.removeEventListener('devicemotion', handleMotion);
            addLog('Listener de devicemotion removido', 'info');
        }
        
        // Función para manejar datos de movimiento
        function handleMotion(event) {
            const now = Date.now();
            if (now - lastUpdate < updateInterval) return;
            lastUpdate = now;
            
            // Datos de aceleración
            const acceleration = event.accelerationIncludingGravity;
            if (acceleration) {
                const x = acceleration.x || 0;
                const y = acceleration.y || 0;
                const z = acceleration.z || 0;
                const magnitude = Math.sqrt(x*x + y*y + z*z);
                
                accelX.textContent = x.toFixed(2);
                accelY.textContent = y.toFixed(2);
                accelZ.textContent = z.toFixed(2);
                accelMagnitude.textContent = magnitude.toFixed(2);
                
                // Cambiar color según la magnitud
                const intensity = Math.min(magnitude / 20, 1);
                const red = Math.floor(255 * intensity);
                const green = Math.floor(255 * (1 - intensity));
                accelMagnitude.style.color = `rgb(${red}, ${green}, 0)`;
            }
            
            // Datos de rotación
            const rotation = event.rotationRate;
            if (rotation) {
                const alpha = rotation.alpha || 0;
                const beta = rotation.beta || 0;
                const gamma = rotation.gamma || 0;
                const magnitude = Math.sqrt(alpha*alpha + beta*beta + gamma*gamma);
                
                gyroAlpha.textContent = alpha.toFixed(2);
                gyroBeta.textContent = beta.toFixed(2);
                gyroGamma.textContent = gamma.toFixed(2);
                gyroMagnitude.textContent = magnitude.toFixed(2);
                
                // Cambiar color según la magnitud
                const intensity = Math.min(magnitude / 50, 1);
                const red = Math.floor(255 * intensity);
                const green = Math.floor(255 * (1 - intensity));
                gyroMagnitude.style.color = `rgb(${red}, ${green}, 0)`;
            }
        }
        
        // Event listeners
        permissionBtn.addEventListener('click', requestPermissions);
        startBtn.addEventListener('click', startSensors);
        stopBtn.addEventListener('click', stopSensors);
        
        // Inicialización
        addLog('Sistema de prueba de sensores iniciado', 'info');
        addLog(`User Agent: ${navigator.userAgent}`, 'info');
        addLog(`DeviceMotionEvent disponible: ${typeof DeviceMotionEvent !== 'undefined'}`, 'info');
        addLog(`requestPermission disponible: ${typeof DeviceMotionEvent.requestPermission === 'function'}`, 'info');
        
        // Auto-solicitar permisos si no es iOS
        if (typeof DeviceMotionEvent.requestPermission !== 'function') {
            setTimeout(() => {
                requestPermissions();
            }, 1000);
        }
    </script>
</body>
</html>
