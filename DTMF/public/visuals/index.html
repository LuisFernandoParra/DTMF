<!DOCTYPE html>
<html>
<head>
    <title>Visualizador DTMF</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/addons/p5.sound.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: black; }
    </style>
</head>
<body>
    <script>
        const socket = io();

        // ------------------------------------
        // VARIABLES GLOBALES (AÑADIDO: fireworks)
        // ------------------------------------
        let estadoActual = 0;
        let fotoMostrada = null;
        let stickers = []; 
        let shakeMagnitude = 0;
        let textoAnimado = "Junten todos para la foto";
        
        let fireworks = []; // ARRAY GLOBAL PARA ALMACENAR LOS FUEGOS ARTIFICIALES ACTIVOS

        let musicaFondo;
        const stickerImages = {};

        function preload() {
            // Precargamos las imágenes de los stickers.
            stickerImages['sticker-1'] = loadImage('../assets/palmera.png');
            stickerImages['sticker-2'] = loadImage('../assets/palmera.png');
            stickerImages['sticker-3'] = loadImage('../assets/palmera.png');
            stickerImages['sticker-4'] = loadImage('../assets/palmera.png');

            // Cargar la música
            musicaFondo = loadSound('../assets/sonido/cancion.mp3');
        }

        function setup() {
            createCanvas(windowWidth, windowHeight);
            textAlign(CENTER, CENTER);
            textSize(50);
            noStroke();
        }

        function draw() {
            background(0);

            // Estado 1: Pantalla de espera para la foto
            if (estadoActual === 1) {
                fill(255);
                text(textoAnimado, width / 2, height / 2);
            } 
            
            // Estado 2: Foto tomada y maraca activa (¡LÓGICA EXISTENTE!)
            else if (estadoActual === 2) {
                if (fotoMostrada) {
                    imageMode(CENTER);
                    image(fotoMostrada, width / 2, height / 2, windowWidth, windowHeight);
                }
                
                // Dibujar los stickers en la pantalla
                stickers.forEach(s => {
                    const stickerImg = stickerImages[s.stickerId];
                    if (stickerImg) {
                        // Calcular las coordenadas absolutas
                        const x = s.x * width;
                        const y = s.y * height;
                        imageMode(CENTER);
                        image(stickerImg, x, y, 100, 100); 
                    }
                });

                // Efecto de la maraca
                if (shakeMagnitude > 0) {
                    fill(255, 255, 255, 100);
                    noStroke();
                    ellipse(width / 2, height / 2, shakeMagnitude * 10);
                    shakeMagnitude *= 0.9;
                }
            }
            
            // Estado 3: Foto final (¡LÓGICA EXISTENTE!)
            else if (estadoActual === 3) {
                if (fotoMostrada) {
                    imageMode(CENTER);
                    image(fotoMostrada, width / 2, height / 2, windowWidth, windowHeight);
                }
            }

            // ===============================================
            // ESTADO 4: FUEGOS ARTIFICIALES (¡LÓGICA NUEVA!)
            // ===============================================
            else if (estadoActual === 4) {
                fill(255);
                textSize(60);
                text("¡LANZA LOS PETARDOS!", width / 2, height / 2);

                // Aplicar gravedad global a todos los fuegos no explotados
                let gravity = createVector(0, 0.2);
                
                // Actualizar y dibujar fuegos artificiales
                for (let i = fireworks.length - 1; i >= 0; i--) {
                    if (!fireworks[i].exploded) {
                        fireworks[i].applyForce(gravity);
                    }
                    fireworks[i].update();
                    fireworks[i].show();

                    // Eliminar los fuegos artificiales que ya terminaron
                    if (fireworks[i].isFinished()) {
                        fireworks.splice(i, 1);
                    }
                }
            }
        }

        // ------------------------------------
        // CLASES DE PARTÍCULAS (¡AÑADIDO!)
        // ------------------------------------

        class Firework {
            constructor(mobileId, intensity) {
                // Posición inicial aleatoria en la parte inferior del canvas
                this.pos = createVector(random(width * 0.2, width * 0.8), height * 0.9);
                this.vel = createVector(0, random(-15, -20)); // Velocidad inicial hacia arriba
                this.acc = createVector(0, 0); 
                
                // El color depende del móvil (A=Rojos/Naranjas, B=Azules/Cianes)
                if (mobileId === 'mobile_a') {
                    this.color = color(random(255, 255), random(100, 160), 0); 
                } else {
                    this.color = color(0, random(150, 255), random(150, 255));
                }

                this.lifespan = 255; 
                this.exploded = false;
                this.explosionParticles = [];
                // Escalar intensidad: de 30-80 (ejemplo de sensor) a 0.5-1.5 (escala de efecto)
                this.intensity = map(intensity, 30, 80, 0.5, 1.5); 
            }

            update() {
                if (!this.exploded) {
                    this.vel.add(this.acc);
                    this.pos.add(this.vel);
                    this.acc.mult(0); 
                    this.lifespan -= 5;
                    
                    // Explota si llega a su altura o se acaba la vida
                    if (this.vel.y > -1 || this.lifespan < 50) {
                        this.explode();
                    }
                } else {
                    // Actualizar partículas de explosión
                    for (let i = this.explosionParticles.length - 1; i >= 0; i--) {
                        this.explosionParticles[i].update();
                        if (this.explosionParticles[i].isFinished()) {
                            this.explosionParticles.splice(i, 1);
                        }
                    }
                }
            }

            applyForce(force) {
                this.acc.add(force);
            }
            
            explode() {
                this.exploded = true;
                let numParticles = Math.floor(random(50, 100) * this.intensity);
                for (let i = 0; i < numParticles; i++) {
                    this.explosionParticles.push(new Particle(this.pos.x, this.pos.y, this.color));
                }
            }

            show() {
                if (!this.exploded) {
                    noStroke();
                    fill(this.color, this.lifespan);
                    ellipse(this.pos.x, this.pos.y, 5, 5);
                } else {
                    for (let p of this.explosionParticles) {
                        p.show();
                    }
                }
            }

            isFinished() {
                return this.exploded && this.explosionParticles.length === 0;
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.pos = createVector(x, y);
                this.vel = p5.Vector.random2D();
                this.vel.mult(random(2, 10));
                this.acc = createVector(0, 0);
                this.lifespan = 255;
                this.color = color;
            }

            update() {
                this.vel.mult(0.95); 
                this.pos.add(this.vel);
                this.lifespan -= 4;
            }

            show() {
                noStroke();
                fill(this.color, this.lifespan);
                ellipse(this.pos.x, this.pos.y, 3, 3);
            }
            
            isFinished() {
                return this.lifespan < 0;
            }
        }

        // ------------------------------------
        // MANEJADORES DE EVENTOS DE SOCKET.IO
        // ------------------------------------

        // ¡NUEVO! Manejador para cambiar al Estado 4: Fuegos Artificiales
        socket.on('cambiar_a_escena_4', () => {
            console.log('Cambiando a escena del Estado 4 (Fuegos Artificiales)...');
            estadoActual = 4;
            fireworks = []; // Limpiar fuegos anteriores
        });
        
        // ¡NUEVO! Manejador para recibir la señal de disparo de los móviles
        socket.on('mostrar_fuego_artificial', (data) => {
            console.log(`Visualizador: Recibido disparo de ${data.mobileId} (Intensidad: ${data.intensity})`);
            
            // Solo crear fuegos si estamos en el estado correcto
            if (estadoActual === 4) {
                let newFirework = new Firework(data.mobileId, data.intensity);
                fireworks.push(newFirework);
            }
        });


        // --- Manejadores de eventos existentes (Actualizados para consistencia) ---

        socket.on('cambiar_a_escena_3', () => {
            console.log('Cambiando a escena del Estado 1...');
            estadoActual = 1;
        });

        socket.on('mostrar_foto', (imageData) => {
            console.log('Visualizador recibe la foto. Cambiando a Estado 2 (Foto/Stickers).');
            estadoActual = 2; // Estado 2 = Foto con Stickers/Maraca
            loadImage(imageData, img => {
                fotoMostrada = img;
            });
        });

        // Manejador para el efecto de la maraca
        socket.on('efecto_maraca', (data) => {
            const magnitude = Math.sqrt(data.x * data.x + data.y * data.y + data.z * data.z);
            shakeMagnitude = magnitude;
            console.log('Visualizador recibe datos de maraca. Magnitud:', magnitude);
        });

        // Manejador para los stickers
        socket.on('agregar_sticker_visualizador', (stickerData) => {
            console.log('Visualizador recibe un sticker.');
            stickers.push(stickerData);
        });

        socket.on('mostrar_foto_final', (data) => {
            console.log('Visualizador recibe la foto final. Cambiando a Estado 3.');
            estadoActual = 3; // Estado 3 = Foto Final
            loadImage(data.foto, img => {
                fotoMostrada = img;
            });
        });

        // Manejar los comandos de música desde el Remoto
        socket.on('control_musica_visualizador', (action) => {
            console.log(`Visualizador recibe orden de música: ${action}`);

            if (musicaFondo.isLoaded()) {
                if (action === 'play' && !musicaFondo.isPlaying()) {
                    musicaFondo.play();
                    console.log('Música de fondo reproducida.');
                } else if (action === 'pause' && musicaFondo.isPlaying()) {
                    musicaFondo.pause();
                    console.log('Música de fondo pausada.');
                } else if (action === 'forward') {
                    const currentTime = musicaFondo.currentTime();
                    const newTime = currentTime + 10;
                    if (newTime < musicaFondo.duration()) {
                        musicaFondo.jump(newTime);
                    }
                    console.log('Música de fondo adelantada 10 segundos.');
                }
            }
        });
    </script>
</body>
</html>