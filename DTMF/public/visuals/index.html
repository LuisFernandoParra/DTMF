<!DOCTYPE html>
<html>
<head>
    <title>Visualizador DTMF</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/addons/p5.sound.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: black; }
    </style>
</head>
<body>
    <script>
        const socket = io();

        let estadoActual = 0;
        let fotoMostrada = null;
        let stickers = []; // Aquí se almacenarán los stickers recibidos
        let shakeMagnitude = 0;
        let textoAnimado = "Junten todos para la foto";

        let musicaFondo;
        
        // Objeto para almacenar las imágenes de los stickers
        const stickerImages = {};

        function preload() {
            // Precargamos las imágenes de los stickers.
            // Asegúrate de que las rutas sean correctas.
            stickerImages['sticker-1'] = loadImage('../assets/palmera.png');
            stickerImages['sticker-2'] = loadImage('../assets/palmera.png');
            stickerImages['sticker-3'] = loadImage('../assets/palmera.png');
            stickerImages['sticker-4'] = loadImage('../assets/palmera.png');

            // Cargar la música
            musicaFondo = loadSound('../assets/sonido/cancion.mp3');
        }

        function setup() {
            createCanvas(windowWidth, windowHeight);
            textAlign(CENTER, CENTER);
            textSize(50);
            noStroke();
        }

        function draw() {
            background(0);

            // Estado 1: Pantalla de espera para la foto
            if (estadoActual === 1) {
                fill(255);
                text(textoAnimado, width / 2, height / 2);
            } 
            
            // Estado 2: Foto tomada y maraca activa
            else if (estadoActual === 2) {
                if (fotoMostrada) {
                    imageMode(CENTER);
                    image(fotoMostrada, width / 2, height / 2, windowWidth, windowHeight);
                }
                
                // ¡NUEVO! Dibujar los stickers en la pantalla
                stickers.forEach(s => {
                    const stickerImg = stickerImages[s.stickerId];
                    if (stickerImg) {
                        // Calcular las coordenadas absolutas
                        const x = s.x * width;
                        const y = s.y * height;
                        imageMode(CENTER);
                        image(stickerImg, x, y, 100, 100); // 100x100 es un tamaño de ejemplo
                    }
                });

                // Efecto de la maraca
                if (shakeMagnitude > 0) {
                    fill(255, 255, 255, 100);
                    noStroke();
                    ellipse(width / 2, height / 2, shakeMagnitude * 10);
                    shakeMagnitude *= 0.9;
                }
            }
            
            // Estado 3: Foto final
            else if (estadoActual === 3) {
                if (fotoMostrada) {
                    imageMode(CENTER);
                    image(fotoMostrada, width / 2, height / 2, windowWidth, windowHeight);
                }
            }
        }

        // --- Manejadores de eventos de Socket.io ---

        socket.on('cambiar_a_escena_3', () => {
            console.log('Cambiando a escena del Estado 3...');
            estadoActual = 1;
        });

        socket.on('mostrar_foto', (imageData) => {
            console.log('Visualizador recibe la foto.');
            estadoActual = 2;
            loadImage(imageData, img => {
                fotoMostrada = img;
            });
        });

        // ¡NUEVO! Manejador para el efecto de la maraca
        socket.on('efecto_maraca', (data) => {
            const magnitude = Math.sqrt(data.x * data.x + data.y * data.y + data.z * data.z);
            shakeMagnitude = magnitude;
            console.log('Visualizador recibe datos de maraca. Magnitud:', magnitude);
        });

        // ¡NUEVO! Manejador para los stickers
        socket.on('agregar_sticker_visualizador', (stickerData) => {
            console.log('Visualizador recibe un sticker.');
            stickers.push(stickerData);
        });

        socket.on('mostrar_foto_final', (data) => {
            console.log('Visualizador recibe la foto final.');
            estadoActual = 3;
            loadImage(data.foto, img => {
                fotoMostrada = img;
            });
        });

        // Manejar los comandos de música desde el Remoto
        socket.on('control_musica_visualizador', (action) => {
            console.log(`Visualizador recibe orden de música: ${action}`);

            if (musicaFondo.isLoaded()) {
                if (action === 'play' && !musicaFondo.isPlaying()) {
                    musicaFondo.play();
                    console.log('Música de fondo reproducida.');
                } else if (action === 'pause' && musicaFondo.isPlaying()) {
                    musicaFondo.pause();
                    console.log('Música de fondo pausada.');
                } else if (action === 'forward') {
                    const currentTime = musicaFondo.currentTime();
                    const newTime = currentTime + 10;
                    // Asegurarse de no adelantar más allá de la duración
                    if (newTime < musicaFondo.duration()) {
                        musicaFondo.jump(newTime);
                    }
                    console.log('Música de fondo adelantada 10 segundos.');
                }
            }
        });
    </script>
</body>
</html>