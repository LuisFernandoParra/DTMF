<!DOCTYPE html>
<html>
<head>
    <title>Visualizador DTMF</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: black; }
    </style>
</head>
<body>
    <script>
        const socket = io();

        // Estado inicial en 0 (pantalla en negro)
        let estadoActual = 0; // 0: inicio, 1: estado 3, 2: foto tomada, 3: final
        let fotoMostrada = null;
        let stickers = [];
        let maracaData = { x: 0, y: 0 };
        let textoAnimado = "Junten todos para la foto";

        function setup() {
            createCanvas(windowWidth, windowHeight);
            textAlign(CENTER, CENTER);
            textSize(50);
            noStroke();
        }

        function draw() {
            background(0);

            // Solo dibuja cuando el estado es 1 (recibido del remoto)
            if (estadoActual === 1) {
                fill(255);
                text(textoAnimado, width / 2, height / 2);
            } else if (estadoActual === 2) {
                // ... (el resto del código para mostrar la foto y stickers es el mismo)
                if (fotoMostrada) {
                    imageMode(CENTER);
                    image(fotoMostrada, width / 2, height / 2, windowWidth, windowHeight);
                }
                
                stickers.forEach(s => {
                    // Aquí iría la lógica para dibujar los stickers
                });
            }
            // Agregamos una condición para que el visualizador también reciba la foto final
             else if (estadoActual === 3) {
                // Aquí podrías mostrar la foto final con los stickers para que la gente la vea
                if (fotoMostrada) {
                    imageMode(CENTER);
                    image(fotoMostrada, width / 2, height / 2, windowWidth, windowHeight);
                }
            }
        }

        // Manejadores de eventos de Socket.io
        socket.on('cambiar_a_escena_3', () => {
            console.log('Cambiando a escena del Estado 3...');
            estadoActual = 1; // Cambia el estado a 1 para que draw() muestre el texto
        });

        socket.on('mostrar_foto', (imageData) => {
            console.log('Visualizador recibe la foto.');
            estadoActual = 2; // Cambia el estado a 2 para mostrar la foto
            loadImage(imageData, img => {
                fotoMostrada = img;
            });
        });

        socket.on('agregar_sticker_visualizador', (stickerData) => {
            console.log('Visualizador recibe un sticker.');
            stickers.push(stickerData);
        });

        socket.on('efecto_maraca', (data) => {
            maracaData = data;
        });

        socket.on('mostrar_foto_final', (data) => {
            console.log('Visualizador recibe la foto final.');
            estadoActual = 3; // Opcional: un nuevo estado para la foto final
            loadImage(data.foto, img => {
                fotoMostrada = img;
            });
            // Opcional: Lógica para mostrar los stickers finales si no se pegaron en el servidor
            stickers = data.stickers;
        });

    </script>
</body>
</html>